<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- å¼ºåˆ¶ä½¿ç”¨å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆService Worker è¦æ±‚ï¼‰ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘ â†’ HLS ç›´æ’­æµ Â· çº¯å‰ç«¯</title>
    
    <!-- å…³é”®ï¼šè·¨åŸŸéš”ç¦» Service Worker (å¿…é¡»ä¸ index.html åŒç›®å½•) -->
    <script src="coi-serviceworker.js"></script>

    <!-- ç¬¬ä¸‰æ–¹åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <style>
        * { box-sizing: border-box; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; }
        body {
            background: linear-gradient(145deg, #0b1a2e 0%, #1a2f3f 100%);
            min-height: 100vh; margin: 0; display: flex; justify-content: center; align-items: center; padding: 16px;
        }
        .card {
            background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6); width: 100%; max-width: 900px;
            padding: 28px 24px; color: #eef4ff;
        }
        h1 {
            font-size: 1.9rem; font-weight: 500; margin-top: 0; margin-bottom: 12px;
            display: flex; align-items: center; gap: 10px;
        }
        h1 small { font-size: 0.8rem; background: #2d4e6e; padding: 4px 12px; border-radius: 40px; color: #bdd9ff; font-weight: 400; }
        .upload-area {
            background: rgba(10, 25, 40, 0.6); border: 2px dashed #3b5f8a; border-radius: 28px;
            padding: 32px 20px; text-align: center; transition: 0.2s; cursor: pointer; margin: 20px 0 18px;
        }
        .upload-area:hover { border-color: #70b0ff; background: rgba(20, 45, 70, 0.8); }
        .upload-icon { font-size: 3.4rem; margin-bottom: 8px; filter: drop-shadow(0 8px 12px #00000040); }
        .file-info {
            background: #1e3a5a; border-radius: 60px; padding: 10px 20px; display: inline-flex;
            align-items: center; gap: 8px; font-weight: 500; margin-top: 10px; border: 1px solid #3a618b;
        }
        button {
            background: #2780d9; border: none; color: white; font-size: 1.2rem; font-weight: 600;
            padding: 14px 32px; border-radius: 60px; cursor: pointer; transition: 0.15s;
            box-shadow: 0 10px 18px -6px #00000080; display: inline-flex; align-items: center; gap: 12px;
            border: 1px solid #62a5f0;
        }
        button:hover:not(:disabled) { background: #3293f0; transform: scale(1.02); border-color: #a0ccff; }
        button:disabled { opacity: 0.45; cursor: not-allowed; filter: grayscale(0.6); }
        .status-panel {
            background: #102433cc; border-radius: 24px; padding: 16px 22px; margin: 20px 0;
            border-left: 6px solid #3b8cbf; font-size: 0.95rem; backdrop-filter: blur(4px);
        }
        .progress-bar { height: 8px; background: #1f405e; border-radius: 10px; overflow: hidden; margin: 12px 0 6px; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #3fa7ff, #7ad0ff); border-radius: 10px; transition: width 0.2s ease; }
        .video-container { background: #0b1a28; border-radius: 28px; padding: 12px; box-shadow: inset 0 0 0 1px #4570a0; }
        video { width: 100%; border-radius: 20px; background: black; display: block; }
        .flex-row { display: flex; flex-wrap: wrap; gap: 16px; align-items: center; justify-content: space-between; }
        .tag { background: #21475f; padding: 6px 16px; border-radius: 24px; font-size: 0.9rem; color: #c7e2ff; }
        .warning-note {
            background: #422f1b; border-left-color: #f0b34b; border-left: 5px solid #f0b34b;
            padding: 12px 20px; border-radius: 20px; margin: 20px 0 0; font-size: 0.9rem; color: #ffdfa7;
        }
        .debug-panel {
            background: #0a1a2a; border-radius: 16px; padding: 12px; margin-top: 20px;
            font-size: 0.9rem; border: 1px solid #2f5577; color: #aaf0e9;
        }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ“¼ è§†é¢‘ â†’ HLS ç›´æ’­æµ <small>çº¯æµè§ˆå™¨è½¬æ¢</small></h1>
        <p style="margin-bottom: 8px; color: #b0cbff;">ä¸Šä¼ è§†é¢‘ï¼Œå³åˆ»è½¬ä¸º m3u8 ç›´æ’­ç‰‡æ®µå¹¶æ’­æ”¾ï¼ˆä¸ç»è¿‡æœåŠ¡å™¨ï¼‰</p>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-area" id="dropZone">
            <div class="upload-icon">ğŸ“‚</div>
            <div style="font-size: 1.2rem;">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ”¾è§†é¢‘</div>
            <div style="font-size: 0.85rem; margin-top: 12px; color: #9bb5d4;">æ”¯æŒ mp4, mov, mkv, avi ç­‰ (ffmpeg å¯è§£å°è£…)</div>
            <input type="file" id="fileInput" accept="video/*" style="display: none;" />
        </div>

        <!-- å·²é€‰æ–‡ä»¶æç¤º -->
        <div id="fileInfo" class="file-info hidden"><span>ğŸ¬</span> <span id="fileName"></span></div>

        <!-- æ“ä½œæŒ‰é’® + æ ¸å¿ƒçŠ¶æ€ -->
        <div class="flex-row" style="margin: 25px 0 10px;">
            <button id="convertBtn" disabled><span>âš¡</span> è½¬ä¸º HLS (m3u8+ts)</button>
            <span class="tag" id="coreStatus">â³ ç­‰å¾…ffmpegæ ¸å¿ƒ</span>
        </div>

        <!-- çŠ¶æ€é¢æ¿ & è¿›åº¦ -->
        <div class="status-panel">
            <div style="display: flex; justify-content: space-between;">
                <span id="statusMessage">ğŸ“Œ è¯·é€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶</span>
                <span id="timeEstimate"></span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%;"></div></div>
            <div style="font-size: 0.85rem; color: #b2d0f0;" id="detailLog"></div>
        </div>

        <!-- è§†é¢‘æ’­æ”¾å™¨ (è½¬æ¢åæ˜¾ç¤º HLS æµ) -->
        <div class="video-container" id="videoContainer" style="display: none;">
            <video id="videoPlayer" controls playsinline></video>
            <div style="margin-top: 10px; display: flex; gap: 8px; align-items: center;">
                <span style="background: #1d4e6b; padding: 4px 16px; border-radius: 24px;">ğŸ”´ ç›´æ’­æµ (HLS)</span>
                <span id="streamInfo"></span>
            </div>
        </div>

        <!-- è¯Šæ–­é¢æ¿ï¼ˆä¸“ä¸ºç§»åŠ¨/å¹³æ¿è®¾è®¡ï¼‰ -->
        <div class="debug-panel" id="debugPanel">
            <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
                <span>ğŸ” éš”ç¦»: <span id="debugIsolated">âŒ æœªå¯ç”¨</span></span>
                <span>ğŸ“¡ SWæ§åˆ¶: <span id="debugSwCtrl">æ£€æŸ¥ä¸­â€¦</span></span>
                <button id="debugRefreshBtn" style="background: #326690; border: none; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem;">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>
            </div>
            <p style="margin: 8px 0 0; color: #b0d0ff; font-size: 0.8rem;">å¦‚æœéš”ç¦»æœªå¯ç”¨ï¼Œè¯·ç¡®ä¿: 1. ä¸åœ¨æ— ç—•æ¨¡å¼ 2. ç‚¹å‡»ä¸Šæ–¹åˆ·æ–° 3. è‹¥ä»æ— æ•ˆï¼Œå»ºè®®éƒ¨ç½²åˆ° Netlifyã€‚</p>
        </div>

        <!-- è·¨åŸŸéš”ç¦»è­¦å‘Š (é»˜è®¤éšè—ï¼Œä»…å½“æœªéš”ç¦»æ—¶æ˜¾ç¤º) -->
        <div class="warning-note" id="sabWarning" style="display: none;">
            âš ï¸ å½“å‰é¡µé¢ç¼ºå°‘è·¨åŸŸéš”ç¦»ç­–ç•¥ï¼ŒSharedArrayBuffer ä¸å¯ç”¨ï¼Œffmpeg å¯èƒ½æ— æ³•è¿è¡Œã€‚<br>
            è¯·å‚è€ƒè¯Šæ–­é¢æ¿æŒ‡å¼•ã€‚
        </div>
    </div>

    <script>
        (function() {
            // ---------- DOM å…ƒç´  ----------
            const fileInput = document.getElementById('fileInput');
            const dropZone = document.getElementById('dropZone');
            const fileInfo = document.getElementById('fileInfo');
            const fileNameSpan = document.getElementById('fileName');
            const convertBtn = document.getElementById('convertBtn');
            const coreStatus = document.getElementById('coreStatus');
            const statusMessage = document.getElementById('statusMessage');
            const progressFill = document.getElementById('progressFill');
            const detailLog = document.getElementById('detailLog');
            const videoContainer = document.getElementById('videoContainer');
            const videoPlayer = document.getElementById('videoPlayer');
            const streamInfo = document.getElementById('streamInfo');
            const sabWarning = document.getElementById('sabWarning');

            // è°ƒè¯•å…ƒç´ 
            const debugIsolated = document.getElementById('debugIsolated');
            const debugSwCtrl = document.getElementById('debugSwCtrl');
            const debugRefreshBtn = document.getElementById('debugRefreshBtn');

            // ---------- å…¨å±€å˜é‡ ----------
            let selectedFile = null;
            let ffmpeg = null;
            let ffmpegLoaded = false;
            let hls = null;
            const createdBlobUrls = [];

            // ---------- æ›´æ–°è°ƒè¯•é¢æ¿ ----------
            function updateDebugInfo() {
                // è·¨åŸŸéš”ç¦»çŠ¶æ€
                const isolated = window.crossOriginIsolated;
                debugIsolated.innerText = isolated ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨';
                debugIsolated.style.color = isolated ? '#8f8' : '#f88';
                // æ˜¾ç¤º/éšè—è­¦å‘Š
                sabWarning.style.display = isolated ? 'none' : 'block';

                // Service Worker æ§åˆ¶çŠ¶æ€
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    debugSwCtrl.innerText = 'âœ… æ˜¯ (' + navigator.serviceWorker.controller.scriptURL.split('/').pop() + ')';
                } else {
                    debugSwCtrl.innerText = 'âŒ å¦';
                }
            }

            // ç›‘å¬ controller å˜åŒ–
            if (navigator.serviceWorker) {
                navigator.serviceWorker.addEventListener('controllerchange', updateDebugInfo);
            }
            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updateDebugInfo();

            // æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®
            debugRefreshBtn.addEventListener('click', () => {
                window.location.reload();
            });

            // ---------- åˆå§‹åŒ– FFmpeg ----------
            function initFFmpeg() {
                if (ffmpeg) return Promise.resolve(ffmpeg);
                const { createFFmpeg, fetchFile } = window.FFmpegWASM;
                ffmpeg = createFFmpeg({ 
                    log: false,
                    corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
                });
                ffmpeg.setLogger(({ message }) => {
                    detailLog.innerText = message.slice(-70);
                });
                ffmpeg.setProgress(({ ratio }) => {
                    progressFill.style.width = Math.round(ratio * 100) + '%';
                });
                return Promise.resolve(ffmpeg);
            }

            async function loadFFmpegCore() {
                if (ffmpegLoaded) return true;
                try {
                    statusMessage.innerText = 'â³ ä¸‹è½½ ffmpeg.wasm æ ¸å¿ƒ (~20MB) ...';
                    coreStatus.innerText = 'â¬‡ï¸ ä¸‹è½½ä¸­';
                    await ffmpeg.load();
                    ffmpegLoaded = true;
                    coreStatus.innerText = 'âœ… ffmpeg å°±ç»ª';
                    statusMessage.innerText = 'âœ… æ ¸å¿ƒåŠ è½½å®Œæˆï¼Œå¯ä»¥è½¬æ¢';
                    return true;
                } catch (err) {
                    console.error('ffmpeg åŠ è½½å¤±è´¥:', err);
                    statusMessage.innerText = 'âŒ æ ¸å¿ƒåŠ è½½å¤±è´¥: ' + err.message;
                    coreStatus.innerText = 'âŒ é”™è¯¯';
                    return false;
                }
            }

            function revokeBlobUrls() {
                while (createdBlobUrls.length) {
                    URL.revokeObjectURL(createdBlobUrls.pop());
                }
            }

            function destroyHls() {
                if (hls) { hls.destroy(); hls = null; }
                videoPlayer.src = '';
            }

            // ---------- æ–‡ä»¶é€‰æ‹© ----------
            function handleFileSelect(file) {
                selectedFile = file;
                fileNameSpan.innerText = file.name + ' (' + (file.size / 1024 / 1024).toFixed(2) + ' MB)';
                fileInfo.classList.remove('hidden');
                convertBtn.disabled = false;
                statusMessage.innerText = 'ğŸ“ å·²é€‰æ‹©: ' + file.name;
                videoContainer.style.display = 'none';
                destroyHls();
                revokeBlobUrls();

                // ä¸´æ—¶é¢„è§ˆåŸè§†é¢‘
                const rawUrl = URL.createObjectURL(file);
                createdBlobUrls.push(rawUrl);
                videoPlayer.src = rawUrl;
                videoContainer.style.display = 'block';
                streamInfo.innerText = 'åŸå§‹é¢„è§ˆ (éHLS)';
            }

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) handleFileSelect(e.target.files[0]);
            });
            dropZone.addEventListener('dragover', (e) => e.preventDefault());
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
            });

            // ---------- è½¬æ¢ ----------
            convertBtn.addEventListener('click', async () => {
                if (!selectedFile) return;
                if (!ffmpegLoaded) {
                    await initFFmpeg();
                    const success = await loadFFmpegCore();
                    if (!success) return;
                }

                convertBtn.disabled = true;
                statusMessage.innerText = 'ğŸ”„ è½¬å°è£…ä¸º HLS ...';
                progressFill.style.width = '10%';
                detailLog.innerText = 'å‡†å¤‡æ–‡ä»¶...';
                destroyHls();
                revokeBlobUrls();

                try {
                    const { fetchFile } = window.FFmpegWASM;
                    ffmpeg.FS('writeFile', 'input', await fetchFile(selectedFile));
                    detailLog.innerText = 'è¿è¡Œ ffmpeg -c copy -hls_time 6 output.m3u8';
                    
                    await ffmpeg.run('-i', 'input', 
                                    '-c', 'copy', 
                                    '-bsf:v', 'h264_mp4toannexb', 
                                    '-hls_time', '6',
                                    '-hls_list_size', '0',
                                    '-hls_playlist_type', 'vod', 
                                    'output.m3u8');

                    progressFill.style.width = '80%';
                    detailLog.innerText = 'ç”Ÿæˆç‰‡æ®µå®Œæˆï¼Œå‡†å¤‡æ’­æ”¾...';

                    const files = ffmpeg.FS('readdir', '/');
                    const tsFiles = files.filter(name => name.endsWith('.ts'));
                    const m3u8File = files.find(name => name.endsWith('.m3u8'));
                    
                    if (!m3u8File) throw new Error('æœªç”Ÿæˆ m3u8 æ–‡ä»¶');
                    if (tsFiles.length === 0) throw new Error('æœªç”Ÿæˆ ts ç‰‡æ®µ');

                    // ä¸ºæ¯ä¸ª ts æ–‡ä»¶ç”Ÿæˆ Blob URL
                    const tsBlobMap = {};
                    for (let tsName of tsFiles) {
                        const data = ffmpeg.FS('readFile', tsName);
                        const blob = new Blob([data.buffer], { type: 'video/MP2T' });
                        tsBlobMap[tsName] = URL.createObjectURL(blob);
                        createdBlobUrls.push(tsBlobMap[tsName]);
                    }

                    // ä¿®æ”¹ m3u8 å†…å®¹ï¼Œå°† ts æ–‡ä»¶åæ›¿æ¢ä¸º blob url
                    const m3u8Data = ffmpeg.FS('readFile', m3u8File);
                    const decoder = new TextDecoder('utf-8');
                    let m3u8Content = decoder.decode(m3u8Data);
                    const lines = m3u8Content.split('\n');
                    const newLines = lines.map(line => {
                        const trimmed = line.trim();
                        if (!trimmed.startsWith('#') && trimmed.endsWith('.ts') && tsBlobMap[trimmed]) {
                            return tsBlobMap[trimmed];
                        }
                        return line;
                    });
                    const modifiedM3u8 = newLines.join('\n');
                    const m3u8Blob = new Blob([modifiedM3u8], { type: 'application/vnd.apple.mpegurl' });
                    const m3u8Url = URL.createObjectURL(m3u8Blob);
                    createdBlobUrls.push(m3u8Url);

                    progressFill.style.width = '100%';
                    statusMessage.innerText = 'âœ… è½¬æ¢å®Œæˆï¼æ’­æ”¾ä¸­';
                    detailLog.innerText = `ç”Ÿæˆäº† ${tsFiles.length} ä¸ª ts ç‰‡æ®µ`;

                    if (Hls.isSupported()) {
                        hls = new Hls();
                        hls.loadSource(m3u8Url);
                        hls.attachMedia(videoPlayer);
                        hls.on(Hls.Events.MANIFEST_PARSED, () => {
                            videoPlayer.play().catch(() => {});
                        });
                        streamInfo.innerText = `HLS (${tsFiles.length}ç‰‡æ®µ) â€¢ çº¯å‰ç«¯`;
                    } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                        videoPlayer.src = m3u8Url;
                        streamInfo.innerText = `Safari HLS â€¢ ${tsFiles.length}ç‰‡æ®µ`;
                    } else {
                        throw new Error('æ­¤æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾');
                    }

                    videoContainer.style.display = 'block';
                } catch (err) {
                    console.error(err);
                    statusMessage.innerText = 'âŒ è½¬æ¢å¤±è´¥: ' + err.message;
                    detailLog.innerText = 'é”™è¯¯è¯¦æƒ…è§æ§åˆ¶å°';
                } finally {
                    convertBtn.disabled = false;
                }
            });

            window.addEventListener('beforeunload', revokeBlobUrls);
        })();
    </script>
</body>
</html>
